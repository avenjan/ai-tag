import{q,x as Q,c as X,m as Y,i as E,e as _,s as H,B as Z,F as J,h as V,n as ee,p as te,C as ne,t as O,w as re,g as z,f as N,u as oe,b as se,v as ae}from"./web.9ee1b91f.js";import{c as ie,d as ce,e as le,T as ue}from"./HeaderSecond.4fa7884b.js";import{O as P,V as de,x as j}from"./index.4f2c4b12.js";import{i as fe,s as D}from"./TagsConvertor.b3f5406f.js";import{P as pe,F as ge,g as me}from"./index.b92d985b.js";import{G as A}from"./GlobalData.4e554cac.js";import{N as ve}from"./notice.940364ec.js";import{M as $}from"./MessageHInt.3d0a2276.js";import{C as k,h as he}from"./index.79db8632.js";import{u as W}from"./index.c584f020.js";import{u as be}from"./Webview.b36c6241.js";var we=Object.defineProperty,xe=Object.defineProperties,ye=Object.getOwnPropertyDescriptors,B=Object.getOwnPropertySymbols,Se=Object.prototype.hasOwnProperty,_e=Object.prototype.propertyIsEnumerable,K=(t,e,n)=>e in t?we(t,e,{enumerable:!0,configurable:!0,writable:!0,value:n}):t[e]=n,Ee=(t,e)=>{for(var n in e||(e={}))Se.call(e,n)&&K(t,n,e[n]);if(B)for(var n of B(e))_e.call(e,n)&&K(t,n,e[n]);return t},Me=(t,e)=>xe(t,ye(e));const $e=t=>{let e;return ne(()=>{e&&e.destroy()}),{initSort(n){e=new ie(n,t)},getSortable(){return e}}},R=O("<div></div>",2),Ae=re({}),Ne=pe(function(t){var e,n;const u=q(Ae),s=Q({options:(e=u.options)!=null?e:{}},t),f=P(s.each),w=Math.random().toString(),c=s.getId||(r=>r.id.toString()),v=P((n=s.disabled)!=null?n:!1),l=()=>{const r=i().toArray();return r.filter((o,p)=>o!==w&&r.indexOf(o)===p)};de(()=>{const r=i();r&&r.option("disabled",v())},[v]);const d=()=>{const r=l();f(()=>{var o;const p=((o=u.sharedData)==null?void 0:o.flatMap(h=>h()))||f();return r.map(h=>p.find(g=>c(g)===h)).filter(h=>h)})},{initSort:a,getSortable:i}=$e(Me(Ee({},s.options),{setData:s.setData,onSort(){var r,o;(o=(r=s.options)==null?void 0:r.onSort)==null||o.apply(this,arguments),d()}}));return X(()=>{const r=i();if(r){const o=f().map(p=>c(p));l().join(",")!==o.join(",")&&r.sort(o)}}),(()=>{const r=R.cloneNode(!0);return a(r),Y(r,()=>ge(s),!1,!0),E(r,_(J,{get each(){return[...f(),null]},get fallback(){return s.fallback},children:(o,p)=>{if(o===null)return(()=>{const g=R.cloneNode(!0);return H(g,"data-id",w),g})();const h=Z(()=>s.children(o,p))();return h.dataset.id=c(o),h}})),V(o=>{const p=s.class(),h=s.style;return p!==o._v$&&ee(r,o._v$=p),o._v$2=te(r,h,o._v$2),o},{_v$:void 0,_v$2:void 0}),r})()});function De(t,e){return e===void 0&&(e=15),+parseFloat(Number(t).toPrecision(e))}function M(t){var e=t.toString().split(/[eE]/),n=(e[0].split(".")[1]||"").length-+(e[1]||0);return n>0?n:0}function L(t){if(t.toString().indexOf("e")===-1)return Number(t.toString().replace(".",""));var e=M(t);return e>0?De(Number(t)*Math.pow(10,e)):Number(t)}function Te(t){(t>Number.MAX_SAFE_INTEGER||t<Number.MIN_SAFE_INTEGER)&&console.warn(t+" is beyond boundary when transfer to integer, the results may not be accurate")}function F(t){return function(){for(var e=[],n=0;n<arguments.length;n++)e[n]=arguments[n];var u=e[0],s=e.slice(1);return s.reduce(function(f,w){return t(f,w)},u)}}var T=F(function(t,e){var n=L(t),u=L(e),s=M(t)+M(e),f=n*u;return Te(f),f/Math.pow(10,s)}),U=F(function(t,e){var n=Math.pow(10,Math.max(M(t),M(e)));return(T(t,n)+T(e,n))/n}),G=F(function(t,e){var n=Math.pow(10,Math.max(M(t),M(e)));return(T(t,n)-T(e,n))/n});const Oe=({usersCollection:t})=>{const{deleteMode:e,emphasizeAddMode:n,emphasizeSubMode:u,MaxEmphasize:s}=A.getApp("data"),f=(c,v)=>{if(e())return t(l=>l.filter(d=>d!==c));if(n()&&!v||v&&u())return t(l=>{const d=l.findIndex(r=>r===c),a=l[d],i=[...l];return a.weight?(i[d]={...a,weight:U(a.weight,1).toString()},i):typeof a.emphasize!="number"||a.emphasize<s()?(i[d]={...a,emphasize:(a.emphasize??0)+1},i):l});if(u()&&!v||v&&n())return t(l=>{const d=l.findIndex(r=>r===c),a=l[d],i=[...l];if(a.weight){const r=G(a.weight,1);return i[d]={...a,weight:r<0?"0.0":r.toString()},i}else if(typeof a.emphasize!="number"||a.emphasize>-1*s())return i[d]={...a,emphasize:(a.emphasize??0)-1},i;return l})};return{wheelEvent:me((c,v)=>{const l=v/150;if(n()||u())return l>0?t(d=>{const a=d.findIndex(p=>p===c),i=d[a],r=[...d],o=U(i.weight??0,.1);return r[a]={...i,weight:o<0?"0.0":o.toString()},r}):t(d=>{const a=d.findIndex(p=>p===c),i=d[a],r=[...d],o=G(i.weight??0,.1);return r[a]={...i,weight:o<0?"0.0":o.toString()},r})},50),clickEvent:f}};var Ce=["Shift","Meta","Alt","Control"],Ie=typeof navigator=="object"&&/Mac|iPod|iPhone|iPad/.test(navigator.platform)?"Meta":"Control";function I(t,e){return typeof t.getModifierState=="function"&&t.getModifierState(e)}function ze(t){return t.trim().split(" ").map(function(e){var n=e.split(/\b\+/),u=n.pop();return[n=n.map(function(s){return s==="$mod"?Ie:s}),u]})}function Fe(t,e){var n;e===void 0&&(e={});var u=(n=e.timeout)!=null?n:1e3,s=Object.keys(t).map(function(c){return[ze(c),t[c]]}),f=new Map,w=null;return function(c){c instanceof KeyboardEvent&&(s.forEach(function(v){var l=v[0],d=v[1],a=f.get(l)||l;(function(i,r){return!(r[1].toUpperCase()!==i.key.toUpperCase()&&r[1]!==i.code||r[0].find(function(o){return!I(i,o)})||Ce.find(function(o){return!r[0].includes(o)&&r[1]!==o&&I(i,o)}))})(c,a[0])?a.length>1?f.set(l,a.slice(1)):(f.delete(l),d(c)):I(c,c.key)||f.delete(l)}),w&&clearTimeout(w),w=setTimeout(f.clear.bind(f),u))}}function Pe(t,e,n){var u;n===void 0&&(n={});var s=(u=n.event)!=null?u:"keydown",f=Fe(e,n);return t.addEventListener(s,f),function(){t.removeEventListener(s,f)}}const je=O('<section id="user-select-prompt" class="user-selected blur-background relative my-2 flex w-full flex-col overflow-visible rounded-xl border border-solid border-gray-600 bg-slate-900/20 p-2"><!#><!/><!#><!/><!#><!/><!#><!/></section>',10),ke=O('<span class="pointer-events-none absolute top-12 w-full whitespace-pre-wrap text-center font-light text-sky-500"></span>',2),Be=O("<div></div>",2),Ke=t=>{const{redo:e,undo:n}=A.getApp("tag-control");Pe(t,{"$mod+KeyZ":u=>{u.preventDefault(),n()},"$mod+KeyY":u=>{u.preventDefault(),e()}})},Je=()=>{const{usersCollection:t}=A.getApp("tag-control"),{t:e}=W();return(()=>{const n=z(je),u=n.firstChild,[s,f]=N(u.nextSibling),w=s.nextSibling,[c,v]=N(w.nextSibling),l=c.nextSibling,[d,a]=N(l.nextSibling),i=d.nextSibling,[r,o]=N(i.nextSibling);return oe(p=>{Ke(p)},n),E(n,_(ce,{}),s,f),E(n,_(Re,{usersCollection:t}),c,v),E(n,(()=>{const p=se(()=>t().length===0);return()=>p()&&(()=>{const h=z(ke);return E(h,()=>e("userSelect.hint.add")),h})()})(),d,a),E(n,_(le,{}),r,o),n})()},Re=t=>{const{usersCollection:e}=t,{deleteMode:n,enMode:u,emphasizeAddMode:s,emphasizeSubMode:f,showLangInLine1:w}=A.getApp("data"),{lists:c,TagsHistory:v,injectTags:l}=A.getApp("tag-control"),{wheelEvent:d,clickEvent:a}=Oe({usersCollection:e}),i=j(()=>fe()?s()||f()||n():!1),{send:r}=he();let o=0;const{t:p}=W(),h=(g,x,m)=>{const b=e();let y=m.ctrlKey,S=m.altKey;console.log(g);const C=D(g,c());return l(b,C,y,S,e),m.done=!0,!1};return _(k,{detect:{ADD_BEFORE(){$.success(p("userSelect.message.addTail"))},INPUT_MAGIC(g,x){x.ctrlKey?$.success(p("userSelect.message.combine")):x.altKey?$.success(p("userSelect.message.TailAdd")):$.success(p("userSelect.message.input"))}},receive:{ADD_BEFORE(g,x,m){return m.ignore=!0,e(b=>[...b,...D(g,c())]),!1},INPUT_MAGIC:h,extra(g,x,m){if(m.ignore)return;const b=x&&x.getData("text");if(console.log("触发文字传递"),b){const y=e();v.addToHistory(y);const S=D(b,c());l(y,S,m.ctrlKey,m.altKey,e)}}},get children(){return _(Ne,{class:"scroll-box flex flex-wrap content-baseline gap-2 overflow-y-auto overflow-x-hidden p-2  text-sm",style:{"max-height":"40vh","min-height":"20vh"},setData:(g,x)=>{const m=e().find(b=>b.en===x.dataset.id);m&&r(g,{type:"USER_SELECTED",data:m})},each:e,options:{},disabled:i,children:g=>{const x=g.text===`
`?`
${o++}`:g.en;return g.id=x,(()=>{const m=z(Be);return H(m,"data-id",x),E(m,_(k,{detect:{ADD_BEFORE(){$.success(p("userSelect.message.addBefore"))}},receive:{ADD_BEFORE(b){e(y=>{const S=[...y],C=y.indexOf(g)??S.length;return S.splice(C,0,...D(b,c())),S}),ve.success(p("success"))},INPUT_MAGIC:h},get children(){return _(ue,{data:g,en:u,get cn(){return j(()=>w()||!u())},get onClick(){return g.text===`
`?()=>{n()&&e(b=>b.filter(y=>y!==g))}:a},onWheel:(b,y,S)=>{S.preventDefault(),d(b,y)}})}})),V(b=>ae(m,{["basis-full"]:g.text===`
`},b)),m})()}})}})},et=()=>{const{nav:t}=be();localStorage.getItem("version_news")!=="5.6.0"&&t("/news")};export{Re as T,Je as U,et as t};
